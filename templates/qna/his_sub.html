{% extends 'base.html' %}
{% block content %}
<main role="main">
    <div class="jumbo-tron" style="background-color: #ffffff; padding-top: 100px; padding-bottom: 50px;">
        <div class="container" style="color: #212931;" >
            <h1 class="display-2"><b>Kor-History Q&A</b>
            </h1>
            <br>
          <h4>현재 선택된 context는 {{ room_name }}입니다.</h4>
        </div>
    </div>

  <div class="container">
    <div class="row">
      <div  class="col-md-h text-center" style="height: 50px; width: 250px; margin-top: 40px; border: 1px; background-color: #212931; color:#fff; padding-top: 12px;">
        본문 내용
      </div>
      <div  class="col-md-h text-center" style="height: 40px; width: 250px; margin-top: 50px; ">
         <button type="submit" id="domain_button1" style="background-color: {{ domain_bg.0 }}; color: #fff; width: 100%; border: 0px; height: 40px;" onclick="location.href='{{ redi_url_1 }}';"> 구분 01</button>
      </div>
      <div  class="col-md-h text-center" style="height: 40px; margin-top: 50px; ">
         <button type="submit" id="domain_button2" style="background-color: {{ domain_bg.1 }}; color: #fff; width: 100%; border: 0px; height: 40px;" onclick="location.href='{{ redi_url_2 }}';"> 구분 02 </button>
      </div>
      <div  class="col-md-h text-center" style="height: 40px; margin-top: 50px; ">
         <button type="submit" id="domain_button3" style="background-color: {{ domain_bg.2 }}; color: #fff; width: 100%; border: 0px; height: 40px;" onclick="location.href='{{ redi_url_3 }}';"> 구분 03 </button>
      </div>
    </div>
    <div class="row">
      <div style="width:100%; background-color: #fafafa; border: #ddd solid 0px; padding: 10px;">
        <textarea type="text" name ="myMessage_context" id="myMessage_context" rows="10" style="width: 100%;">{{ contexts }}</textarea>
      </div>
    </div>
    <br>
    <div style="margin-top: 50px; margin-bottom: 20px;">
      <h4 style="font-size: 24px; font-weight: bold;">답변 출력</h4>
    </div>
    <div class="row">
      <div style="width:100%; background-color: #fafafa; border: #ddd solid 0px; padding: 10px;">
        <textarea id="answer-log" style="width: 100%; resize: none;" disabled ="True" rows="3"></textarea>
      </div>
    </div>
    <div class="row text-center" style="background-color: #fafafa; border: #ddd solid 0px; margin-top: 40px; padding: 10px;">
      <table style="width: 100%;">
        <tbody>
        <tr>
          <th style="background-color: #4c5462;">질문 선택</th>
          <td>
            <select type="text" name="myMessage_question_2" id="myMessage_question_2" style="height: 40px; padding-top: 5px; width : 100%;" >
              {% if len_question == 4 %}
                <option value="{{ question.0 }}"> {{ question.0 }} </option>
                <option value="{{ question.1 }}"> {{ question.1 }} </option>
                <option value="{{ question.2 }}"> {{ question.2 }} </option>
                <option value="{{ question.3 }}"> {{ question.3 }} </option>
              {% endif %}
              {% if len_question == 3 %}
                <option value="{{ question.0 }}"> {{ question.0 }} </option>
                <option value="{{ question.1 }}"> {{ question.1 }} </option>
                <option value="{{ question.2 }}"> {{ question.2 }} </option>
              {% endif %}
            </select>
          </td>
          <td width="150px">
            <button type="submit" id="sendbutton_2" style="background-color: #e67371; color: #fff; width: 150px; border: 1px solid #e67371; height: 40px;"> 답변 찾기 </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <div class="row" style="margin-top: 30px;">
      <div  class="col-md-h text-center" style="background-color: #212931; color:#fff; width: 250px; margin-top: 20px; height: 50px; padding-top: 12px;">
        질문 입력
      </div>
      <div style="width:100%; background-color: #fafafa; border: #ddd solid 0px; padding: 10px;">
        <input type='text' name="myMessage_question_1" id="myMessage_question_1" rows="2" style="width: 100%;" placeholder="질문을 입력해 주세요.">
      </div>
    </div>
    <div class="row text-center" style="width: 100%; margin-top: 40px; margin-bottom: 50px; display: inline-block;">
      <button type="submit" id="sendbutton_1" style="background-color: #e67371; color: #fff; width: 150px; border: 1px solid #e67371; height: 40px;" > 답변 찾기 </button>
    </div>
    <hr>
    <div style="margin-top: 50px; margin-bottom: 20px;">
      <h4 style="font-size: 24px; font-weight: bold;">문장 길이별 출력 데이터</h4>
      <p>선택된 context 를 문장 별로 나누고 한 문장씩 줄이며 출력 데이터(문장 수, 답변, 점수, 걸린 시간)를 확인 합니다.</p>
    </div>
    <div class="row">
      <div style="width:100%; background-color: #fafafa; border: #ddd solid 0px; padding: 10px;">
        <textarea id="list_context_slice_testing_log" style="width: 100%; resize: none;" disabled ="True" rows="10"></textarea>
      </div>
    </div>
    <div class="row text-center" style="width: 100%; margin-top: 40px; margin-bottom: 100px; display: inline-block;">
      <button type="submit" id="sendbutton_3" style="background-color: #e67371; color: #fff; width: 40%; margin-right: 5%; border: 1px solid #e67371; height: 40px;"> 선택문 테스트 </button>
      <button type="submit" id="sendbutton_4" style="background-color: #e67371; color: #fff; width: 40%; border: 1px solid #e67371; height: 40px;"> 직접 입력 테스트 </button>
    </div>
  </div>
</main>
<footer class="container" style="margin-top: 100px;">
  <p>&copy;Team LUT. All rights reserved. &emsp;|&emsp; &copy;TwoBlock Ai. All rights reserved.</p>
</footer>
{{ room_name|json_script:"room-name" }}
<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/qna/'
        + roomName
        + '/'
    );

<!--    웹소켓이 데이터를 받을 때 실행   -->
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.btn_id == 1){
          document.querySelector('#answer-log').value = ('답변: ' + '(N/A)' + '\n' + '점수: ' + '(N/A)' + '\n' + '걸린 시간: ' + '(N/A)');
        } else {
          document.querySelector('#answer-log').value = ('답변: '+ data.response_answer + '\n' + '점수: ' + data.response_score + '\n' + '걸린 시간: ' + data.end_time);
        }
        document.querySelector('#list_context_slice_testing_log').value = (data.list_context_slice_testing_data);
        $('#sendbutton_1').text('답변 찾기');
        $('#sendbutton_1').attr("disabled", false);
        $('#sendbutton_2').text('답변 찾기');
        $('#sendbutton_2').attr("disabled", false);
        $('#sendbutton_3').text('선택문 테스트');
        $('#sendbutton_3').attr("disabled", false);
        $('#sendbutton_4').text('직접 입력 테스트');
        $('#sendbutton_4').attr("disabled", false);
        $('#myMessage_question_1').attr("disabled", false);
        $('#myMessage_question_2').attr("disabled", false);
    };

<!--    웹소켓이 닫힐 때 실행   -->
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };


<!--    sendbutton_1 클릭시 실행   -->
    document.querySelector('#sendbutton_1').onclick = function(e) {
        const contextInputDom = document.querySelector('#myMessage_context');
        const questionInputDom = document.querySelector('#myMessage_question_1');
        const context = contextInputDom.value;
        const question = questionInputDom.value;

        var special_pattern = /[`~!@#$%^&*|\\\'\";:\/]/gi;
        var blank_pattern =  /^\s+|\s+$/g;

        if (question === '' || question.replace(blank_pattern, '')==''){
          $('#myMessage_question_1').attr("placeholder", "질문이 입력되지 않았습니다.");
          document.querySelector('#myMessage_question_1').value =("질문이 입력되지 않았습니다.");
          setTimeout(function(){
            document.querySelector('#myMessage_question_1').value =("");
            $('#myMessage_question_1').attr("placeholder", "질문을 입력해 주세요.");
            }, 1500);
        }else if(special_pattern.test(question)==true){
          $('#myMessage_question_1').attr("placeholder", "'?'를 제외한 특수문자는 입력할 수 없습니다.");
          document.querySelector('#myMessage_question_1').value =("'?'를 제외한 특수문자는 입력할 수 없습니다.");
          setTimeout(function(){
            document.querySelector('#myMessage_question_1').value =("");
            $('#myMessage_question_1').attr("placeholder", "질문을 입력해 주세요.");
            }, 1500);
        }else {
          const btn_id = '2'
          chatSocket.send(JSON.stringify({
              'context': context,
              'question': question,
              'btn_id': btn_id,
          }));
              contextInputDom.value = context;
              questionInputDom.value= question;
              $('#sendbutton_1').text('찾는중...');
              $('#sendbutton_1').attr("disabled", true);
              $('#myMessage_question_1').attr("disabled", true);
        };
    };

<!--    sendbutton_2 클릭시 실행   -->
    document.querySelector('#sendbutton_2').onclick = function(e) {
        const contextInputDom = document.querySelector('#myMessage_context');
        const questionInputDom = document.querySelector('#myMessage_question_2');
        const context = contextInputDom.value;
        const question = questionInputDom.value;
        const btn_id = '2'
        chatSocket.send(JSON.stringify({
            'context': context,
            'question': question,
            'btn_id': btn_id,
        }));
            contextInputDom.value = context;
            questionInputDom.value= question;
            $('#sendbutton_2').text('찾는중...');
            $('#sendbutton_2').attr("disabled", true);
            $('#myMessage_question_2').attr("disabled", true);

    };

<!--    sendbutton_3 클릭시 실행   -->
     document.querySelector('#sendbutton_3').onclick = function(e) {
      const contextInputDom = document.querySelector('#myMessage_context');
      const questionInputDom = document.querySelector('#myMessage_question_2');
      const context = contextInputDom.value;
      const question = questionInputDom.value;
      const btn_id = '1'

      chatSocket.send(JSON.stringify({
          'context': context,
          'question': question,
          'btn_id': btn_id,
      }));
          contextInputDom.value = context;
          questionInputDom.value= question;
          $('#sendbutton_3').text('진행 중...');
          $('#sendbutton_3').attr("disabled", true);
          $('#sendbutton_4').attr("disabled", true);
          document.querySelector('#list_context_slice_testing_log').value = ('프로세스가 진행 중입니다.' + '\n' + '문장 개수에 따라 최대 30초 이상 소요될 수 있습니다.' + '\n' + '잠시 기다려 주세요.');
          $('#list_context_slice_testing_log').attr("disabled", true);

      };

<!--    sendbutton_4 클릭시 실행   -->
     document.querySelector('#sendbutton_4').onclick = function(e) {
      const contextInputDom = document.querySelector('#myMessage_context');
      const questionInputDom = document.querySelector('#myMessage_question_1');
      const context = contextInputDom.value;
      const question = questionInputDom.value;

      var special_pattern = /[`~!@#$%^&*|\\\'\";:\/]/gi;
      var blank_pattern =  /^\s+|\s+$/g;

      if (question === '' || question.replace(blank_pattern, '' )==''){
        $('#myMessage_question_1').attr("placeholder", "질문이 입력되지 않았습니다.");
        document.querySelector('#myMessage_question_1').value =("질문이 입력되지 않았습니다.");
        document.querySelector('#list_context_slice_testing_log').value =("질문이 입력되지 않았습니다.");
        setTimeout(function(){
          document.querySelector('#myMessage_question_1').value =("");
          $('#myMessage_question_1').attr("placeholder", "질문을 입력해 주세요.");
          document.querySelector('#list_context_slice_testing_log').value =("");
          }, 1500);
      } else if(special_pattern.test(question)==true){
        $('#myMessage_question_1').attr("placeholder", "'?'를 제외한 특수문자는 입력할 수 없습니다.");
        document.querySelector('#myMessage_question_1').value =("'?'를 제외한 특수문자는 입력할 수 없습니다.");
        document.querySelector('#list_context_slice_testing_log').value =("'?'를 제외한 특수문자는 입력할 수 없습니다.");
        setTimeout(function(){
          document.querySelector('#myMessage_question_1').value =("");
          $('#myMessage_question_1').attr("placeholder", "질문을 입력해 주세요.");
          document.querySelector('#list_context_slice_testing_log').value =("");
          }, 1500);
      }else {
        const btn_id = '1'
        chatSocket.send(JSON.stringify({
            'context': context,
            'question': question,
            'btn_id': btn_id,
        }));
            contextInputDom.value = context;
            questionInputDom.value= question;
            $('#sendbutton_4').text('진행 중...');
            $('#sendbutton_3').attr("disabled", true);
            $('#sendbutton_4').attr("disabled", true);
            document.querySelector('#list_context_slice_testing_log').value = ('프로세스가 진행 중입니다.' + '\n' + '문장 개수에 따라 최대 30초 이상 소요될 수 있습니다.' + '\n' + '잠시 기다려 주세요.');
            $('#list_context_slice_testing_log').attr("disabled", true);

        };
      };



</script>

{% endblock %}
